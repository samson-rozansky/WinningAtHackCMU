<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Platform</title>
    <!-- Link to the corrected CSS file -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- Include Socket.io and Chart.js if necessary -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        form { margin-bottom: 20px; }
        input, select { padding: 5px; margin-top: 5px; }
        .notifications { color: red; }
    </style>
    <!--<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>-->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <title>Chartjs Charts</title>
</head>
<body>
    <header>
        <img src="{{ url_for('static', filename='images/blockstocks_logo.png') }}" alt="BlockStocks Logo">
        <h1>Welcome, {{ user_name }}!</h1>
    </header>

    <div class="main-container">
        <!-- Left Column: Form -->
        <div class="form-container">
            <!-- Role Selection -->
            <div class="role-selection">
                <div id="buyer-box" class="role-box">Buyer</div>
                <div id="seller-box" class="role-box seller-selected">Seller</div>
                <input type="hidden" name="role" id="role-input" value="seller">
            </div>

            <!-- Price Input -->
            <div class="price-input-wrapper">
                <input type="number" name="price" placeholder="Price" step="0.01" min="0" max="100" required>
            </div>

            <!-- Payment Methods -->
            <h3>Select Payment Method(s)</h3>
            <div class="option-box-group">
                <div class="option-box" data-value="zelle"><span class="label-text">Zelle</span></div>
                <div class="option-box" data-value="paypal"><span class="label-text">PayPal</span></div>
                <div class="option-box" data-value="venmo"><span class="label-text">Venmo</span></div>
                <div class="option-box" data-value="cashapp"><span class="label-text">CashApp</span></div>
            </div>

            <!-- Contact Methods -->
            <h3>Enter Contact Method(s)</h3>
            <div class="option-box-group">
                <input type="text" class="contact-input" name="phone" placeholder="Phone #">
                <input type="email" class="contact-input" name="email" placeholder="Email">
                <input type="text" class="contact-input" name="instagram" placeholder="Instagram username">
                <input type="text" class="contact-input" name="discord" placeholder="Discord handle">
            </div>

            <!-- Submit Button -->
            <button type="submit">Submit</button>
        </div>

        <!-- Right Column: Graph -->
        <div class="graph-container">
            <h2>Current Projected Block Price: $8.07</h2>
            <div style="width: 107%;">
                <div id="chart"></div>
            </div>
        </div>
    </div>
    <!--<div id="chart"></div>-->
 
    <script>
        // Fetch stock data from Flask backend
        fetch('/get_stock_data')
            .then(response => response.json())
            .then(data => {
                var times = data.times;  // Access times list
                var prices = data.prices;  // Access prices list

                var trace = {
                    x: times,
                    y: prices,
                    type: 'scatter',
                    mode: 'lines',
                    line: {color: 'green'}
                };

                var layout = {
                    title: 'Stock Price Over Time',
                    xaxis: { title: 'Time' },
                    yaxis: { title: 'Price' }
                };

                Plotly.newPlot('chart', [trace], layout);
            });
    </script>

    <!-- New Container for Prices, Offers, and Transaction History -->
    <div class="info-container">
        <!-- Current Prices -->
        <div class="info-box">
            <h2>Current Prices</h2>
            <p>min seller price: ${{ min_seller.min_price }}</p>
            <p>max buyer price: ${{ max_buyer.max_price }}</p>
            <button id="buy_min">Buy Min</button>
            <button id="sell_max">Sell Max</button>
        </div>

        <!-- Current Offers -->
        <div class="info-box">
            <h2>Current Offers</h2>
            {% if current_offer %}
                <p>current_offer: {{ current_offer }}</p>
            {% else %}
                <p>No Offer Made</p>
            {% endif %}
            <button id="cancel-offer">Cancel Offer</button>

            {% if pending_transaction is not none %}
            <div id="accept-notif">
               <span>{{ pending_transaction.name }} ({{ pending_transaction.id }}) has accepted your offer.</span>
                <button id="accept-notif-proceed">Press to Proceed</button>
            </div>
            {% endif %}
        </div>

        <!-- Transaction History -->
        <div class="info-box larger">
            <h2>Transaction History</h2>
            <ul>
              {% for entry in log %}
                  <li>{{ entry }}</li>
              {% endfor %}
            </ul>
        </div>
    </div>

    <!-- JavaScript Code -->
    <script>
        // Role selection toggling
        const buyerBox = document.getElementById('buyer-box');
        const sellerBox = document.getElementById('seller-box');
        const roleInput = document.getElementById('role-input');

        buyerBox.addEventListener('click', function () {
            buyerBox.classList.add('buyer-selected');
            sellerBox.classList.remove('seller-selected');
            roleInput.value = 'buyer';
        });

        sellerBox.addEventListener('click', function () {
            sellerBox.classList.add('seller-selected');
            buyerBox.classList.remove('buyer-selected');
            roleInput.value = 'seller';
        });

        // Payment method selection
        document.querySelectorAll('.option-box').forEach(box => {
            box.addEventListener('click', function() {
                this.classList.toggle('selected');
            });
        });
        
        // Additional functionality for cancel offer and accept notification
        document.getElementById("cancel-offer").addEventListener("click", function() {
          fetch('/cancel-offer', {
              method: 'POST'
          })
          .then(response => {
          if (response.redirected) {
              window.location.href = response.url;  // Follow the redirect in JavaScript
          }
        })
        .catch(error => console.error('Error:', error));
      });

      document.getElementById("accept-notif-proceed").addEventListener("click", function() {
          fetch('/accept-notif-proceed', {
              method: 'POST'
          })
          .then(response => {
          if (response.redirected) {
              window.location.href = response.url;  // Follow the redirect in JavaScript
          }
        })
        .catch(error => console.error('Error:', error));
      });
    </script>
</body>
</html>
